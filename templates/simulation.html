{% extends "base.html" %}

{% block title %}Simulation{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-7 map-section">
                <div class="card card-map">
                    <div class="map-container" id="map"></div>
                </div>
            </div>
    
            <div class="col-md-3 graph-section">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-light">Funk Factor</div>
                            <div class="card-body">
                                <div id="line-chart" style="width:100%;height:150px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mt-2">
                        <div class="card">
                            <div class="card-header bg-warning text-light">Crowded and Clouded</div>
                            <div class="card-body">
                                <div id="bar-chart" style="width:100%;height:150px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="col-md-2 list-section">
                <div class="card mb-3">
                    <div class="card-header bg-success text-light">The BO Brigade</div>
                    <ul class="list-group" id="bo-brigade"></ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Include necessary scripts for MapLibre and Plotly -->
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

<!-- Load a stable version of Plotly from a reliable CDN -->
<script src="https://cdn.plot.ly/plotly-2.16.1.min.js"></script> <!-- Using a stable version -->

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const MAPTILER_KEY = "{{ maptiler_key }}";
        const students = {};

        // Initialize the map
        const map = new maplibregl.Map({
            container: 'map',
            style: `https://api.maptiler.com/maps/basic-v2/style.json?key=${MAPTILER_KEY}`,
            center: [-4.290885, 55.872706],
            zoom: 16.5,
            pitch: 50,
            bearing: 0,
            antialias: false
        });

        map.on('load', function () {
            map.addSource('openmaptiles', { type: 'vector', url: `https://api.maptiler.com/tiles/v3/tiles.json?key=${MAPTILER_KEY}` });
            map.addLayer({
                'id': '3d-buildings',
                'source': 'openmaptiles',
                'source-layer': 'building',
                'type': 'fill-extrusion',
                'minzoom': 15,
                'paint': {
                    'fill-extrusion-color': ['interpolate', ['linear'], ['get', 'render_height'], 0, 'lightgray', 200, 'royalblue', 400, 'lightblue'],
                    'fill-extrusion-height': ['interpolate', ['linear'], ['zoom'], 15, 0, 16, ['get', 'render_height']],
                    'fill-extrusion-opacity': 0.6
                }
            });
        });

        // Initialize Plotly graphs
        const lineChartLayout = {
            title: 'Stink Factor Over Time',
            xaxis: { title: 'Time (Minutes)', range: [0, 480] },
            yaxis: { title: 'Stink Level', range: [0, 1] },
        };
        const lineChartData = [];
        Plotly.newPlot('line-chart', lineChartData, lineChartLayout);

        const barChartLayout = {
            title: 'Building Fullness',
            xaxis: { title: 'Buildings' },
            yaxis: { title: 'Fullness', range: [0, 1] },
        };
        const barChartData = [{ x: [], y: [], type: 'bar' }];
        Plotly.newPlot('bar-chart', barChartData, barChartLayout);

        // Socket.IO event listeners
        const socket = io();
        socket.on('new_student', data => addHtmlPointToMap(data.student_id, data.lat, data.lng, data.name, data.stinkLevel, data.poi));
        socket.on('update_student', data => updateHtmlPointOnMap(data.student_id, data.lat, data.lng, data.stinkLevel, data.poi));
        socket.on('update_building', data => updateBuilding(data.building_id, data.buildingName, data.lat, data.lng, data.stinkLevel, data.capacity, data.tick, data.fullness));

        // Function to add a point on the map for a new student
        function addHtmlPointToMap(studentId, lat, lng, name, stinkLevel, poi) {
            if (!students[studentId]) {
                const point = document.createElement('div');
                point.className = 'map-point';
                const pointMarker = new maplibregl.Marker({ element: point, anchor: 'center' }).setLngLat([lng, lat]).addTo(map);

                let labelMarker = null;
                if (poi) {
                    const label = document.createElement('div');
                    label.className = 'map-label';
                    label.innerText = `${name}`;

                    labelMarker = new maplibregl.Marker({ element: label, anchor: 'top', offset: [0, 5] }).setLngLat([lng, lat]).addTo(map);
                }

                students[studentId] = { lat, lng, name, stinkLevel, pointMarker, labelMarker, poi };
            }

            updateBOBrigade();
        }

        // Function to update the position of an existing student
        function updateHtmlPointOnMap(studentId, lat, lng, stinkLevel, poi) {
            if (students[studentId]) {
                students[studentId].pointMarker.setLngLat([lng, lat]);

                if (students[studentId].labelMarker) {
                    students[studentId].labelMarker.setLngLat([lng, lat]);
                } else if (poi && !students[studentId].labelMarker) {
                    const label = document.createElement('div');
                    label.className = 'map-label';
                    label.innerText = `${students[studentId].name}`;

                    students[studentId].labelMarker = new maplibregl.Marker({ element: label, anchor: 'top', offset: [0, 5] }).setLngLat([lng, lat]).addTo(map);
                }

                students[studentId].stinkLevel = stinkLevel;
                students[studentId].poi = poi;
                updateBOBrigade();
            }
        }

        // Function to update the leaderboard (BO Brigade)
        function updateBOBrigade() {
            const listElement = document.getElementById('bo-brigade');
            listElement.innerHTML = '';

            const sortedStudents = Object.values(students).sort((a, b) => b.stinkLevel - a.stinkLevel).slice(0, 20);
            sortedStudents.forEach((student, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                listItem.textContent = `${index + 1}. ${student.name}`;

                const badge = document.createElement('span');
                badge.className = 'badge badge-primary badge-pill';
                badge.textContent = student.stinkLevel;

                listItem.appendChild(badge);
                listElement.appendChild(listItem);
            });
        }

        // Function to update the building data on the map and graphs
        function updateBuilding(buildingId, buildingName, lat, lng, stinkLevel, capacity, tick, fullness) {
            updateLineChart(buildingName, tick, stinkLevel);
            updateBarChart(buildingName, fullness);
        }

        // Update the line chart for stink levels
        // For Line Chart:
        function updateLineChart(buildingName, tick, stinkLevel) {
            console.log('Updating Line Chart:', buildingName, tick, stinkLevel);
            const traceIndex = lineChartData.findIndex(trace => trace.name === buildingName);
            if (traceIndex !== -1) {
                Plotly.extendTraces('line-chart', {
                    x: [[tick]],
                    y: [[stinkLevel]]
                }, [traceIndex]);
            } else {
                const newTrace = {
                    x: [tick],
                    y: [stinkLevel],
                    mode: 'lines',
                    name: buildingName,
                    line: { shape: 'linear' }
                };
                Plotly.addTraces('line-chart', newTrace);
                lineChartData.push(newTrace);
            }
        }

        // For Bar Chart:
        function updateBarChart(buildingName, fullness) {
            console.log('Updating Bar Chart:', buildingName, fullness);
            const index = barChartData[0].x.indexOf(buildingName);
            if (index === -1) {
                barChartData[0].x.push(buildingName);
                barChartData[0].y.push(fullness);
            } else {
                barChartData[0].y[index] = fullness;
            }
            Plotly.react('bar-chart', barChartData, barChartLayout);
        }

    });
</script>
{% endblock %}
